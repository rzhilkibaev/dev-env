#!/usr/bin/env bash
#
# This script is a wrapper around vimdiff for svn diff function.
# Features:
# - THEIRS version is read-only
# - MINE version is editable
# - you can see which revision you are comparing against (part of THEIRS file name)
# - you can see which file you are comparing
# - syntax highlight
#
# This is done by using the actual file as MINE and a descriptive symlink as THEIRS.
# 
# svn launches this script with the following arguments
# 1 -u
# 2 -L
# 3 /local/path/to/file.txt (revision 63002)
# 4 -L
# 5 /local/path/to/file.txt (working copy)
# 6 /local/path/to/.svn/pristine/29/298288cbe8bd66899ece76868823a6afb0d11035.svn-base
# 7 /tmp/svn-rtej8a

set -eo pipefail

if [[ -z $@ || $# != "7" ]] ; then
    echo "Incorrect number of arguments provided"
    exit 1
fi

THEIRS_LABEL="$3"
MINE_LABEL="$5"
THEIRS_FILE="$6"
MINE_FILE="$7"

# Use THEIRS_LABEL to get file name and revision number

# Replace tab with space and then split by spaces
# !!!there is a tab character in the next line!!!
THEIRS_LABEL_COMPONENTS=(${THEIRS_LABEL//	/ })
# get first item (full file name)
FULL_FILE_NAME="${THEIRS_LABEL_COMPONENTS[0]}"
FILE_NAME="$(basename $FULL_FILE_NAME)"
# get second item (revision number) and remove last character ')'
REVISION="${THEIRS_LABEL_COMPONENTS[2]::-1}"
# get random name generated by svn
RANDOM_NAME=$(basename $MINE_FILE)
# make a directory for symlinks using this random name
rm -rf "/tmp/$RANDOM_NAME-dir"
mkdir "/tmp/$RANDOM_NAME-dir"

# Use random part in a directory name since vim-airline conviniently hides it
# in the buffer name list leaving just revision and file name.
LEFT="/tmp/$RANDOM_NAME-dir/$REVISION.$FILE_NAME"
RIGHT=$FULL_FILE_NAME

ln -s "$THEIRS_FILE" "$LEFT"

# I use readonly mode here just for the nice lock sign it has in powerlevel9k
vim -f -d "$LEFT" "$RIGHT" -c "set nomodifiable | set readonly | wincmd l"

# don't bother cleaning up, it's in /tmp
